<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - LinkedIn Ingestion Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="sidebar-wrapper px-0">
                <%- include('../partials/sidebar') %>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <%- include('../partials/header', { pageTitle: title }) %>
                
                <div class="container-fluid py-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8 col-xl-6">
                            <!-- Page Header -->
                            <div class="text-center mb-4">
                                <h2 class="fw-bold mb-3">Add LinkedIn Profile</h2>
                                <p class="text-muted">
                                    Enter a LinkedIn profile URL to start the ingestion process. 
                                    We'll fetch the profile data and associated company information automatically.
                                </p>
                            </div>

                            <!-- Ingestion Form -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-4">
                                    <form id="ingestionForm">
                                        <div class="mb-4">
                                            <label for="linkedinUrl" class="form-label fw-semibold">LinkedIn Profile URL</label>
                                            <input type="url" class="form-control form-control-lg" id="linkedinUrl" name="linkedin_url" 
                                                   placeholder="https://www.linkedin.com/in/username/"
                                                   pattern="https://.*linkedin\.com/in/.+"
                                                   required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Enter the full LinkedIn profile URL (e.g., https://www.linkedin.com/in/username/)
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="suggestedRole" class="form-label fw-semibold">Suggested Role</label>
                                            <select class="form-select form-select-lg" id="suggestedRole" name="suggested_role" required>
                                                <option value="">Select a role...</option>
                                                <option value="CTO">CTO - Chief Technology Officer</option>
                                                <option value="CIO">CIO - Chief Information Officer</option>
                                                <option value="CISO">CISO - Chief Information Security Officer</option>
                                            </select>
                                            <div class="form-text">
                                                <i class="bi bi-star me-1"></i>
                                                This helps with role-specific scoring and analysis
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="includeCompanies" name="include_companies" checked>
                                                <label class="form-check-label fw-semibold" for="includeCompanies">
                                                    Include company profiles from experience
                                                </label>
                                            </div>
                                            <div class="form-text ps-4">
                                                <i class="bi bi-building me-1"></i>
                                                Automatically fetch and store detailed company information for all positions listed in the profile. 
                                                This may take several minutes depending on the number of companies.
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <a href="/ingestion" class="btn btn-outline-secondary btn-lg me-md-2">
                                                <i class="bi bi-arrow-left me-1"></i>Back to Ingestion
                                            </a>
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="bi bi-cloud-arrow-up me-1"></i>Start Ingestion
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Information Cards -->
                            <div class="row mt-4">
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title text-primary">
                                                <i class="bi bi-speedometer2 me-2"></i>What We Extract
                                            </h6>
                                            <ul class="list-unstyled small mb-0">
                                                <li><i class="bi bi-check text-success me-1"></i> Profile information</li>
                                                <li><i class="bi bi-check text-success me-1"></i> Work experience</li>
                                                <li><i class="bi bi-check text-success me-1"></i> Education history</li>
                                                <li><i class="bi bi-check text-success me-1"></i> Skills and certifications</li>
                                                <li><i class="bi bi-check text-success me-1"></i> Company details (when enabled)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 border-0 bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title text-info">
                                                <i class="bi bi-clock-history me-2"></i>Processing Time
                                            </h6>
                                            <ul class="list-unstyled small mb-0">
                                                <li><i class="bi bi-lightning text-warning me-1"></i> Profile only: ~30 seconds</li>
                                                <li><i class="bi bi-hourglass text-info me-1"></i> With companies: 2-10 minutes</li>
                                                <li><i class="bi bi-info-circle text-muted me-1"></i> Depends on experience length</li>
                                                <li><i class="bi bi-shield-check text-success me-1"></i> Rate-limited for reliability</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <div class="mb-4">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h4>Processing LinkedIn Profile</h4>
                    <p class="text-muted mb-0">Please wait while we fetch and process the profile data...</p>
                    <div id="processingStatus" class="mt-3">
                        <small class="text-muted">Initializing...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle me-2"></i>Profile Added Successfully
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Ingestion Completed</h4>
                        <p class="text-muted mb-4">The LinkedIn profile has been successfully processed and stored.</p>
                        <div id="successDetails"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="/profiles" class="btn btn-primary">
                        <i class="bi bi-people me-1"></i>View All Profiles
                    </a>
                    <button type="button" class="btn btn-outline-primary" onclick="addAnother()">
                        <i class="bi bi-plus-circle me-1"></i>Add Another
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js?v=<%= Date.now() %>"></script>
    <script>
        // Form submission handler
        document.getElementById('ingestionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                linkedin_url: formData.get('linkedin_url'),
                suggested_role: formData.get('suggested_role'),
                include_companies: formData.has('include_companies')
            };
            
            // Show processing modal
            const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
            processingModal.show();
            
            // Simulate processing steps for better UX
            const statusEl = document.getElementById('processingStatus');
            const steps = [
                'Validating LinkedIn URL...',
                'Fetching profile data...',
                'Processing work experience...',
                data.include_companies ? 'Fetching company information...' : 'Finalizing profile...',
                'Storing in database...'
            ].filter(Boolean);
            
            let stepIndex = 0;
            const updateStatus = () => {
                if (stepIndex < steps.length) {
                    statusEl.innerHTML = `<small class="text-muted">${steps[stepIndex]}</small>`;
                    stepIndex++;
                    setTimeout(updateStatus, 1500);
                }
            };
            updateStatus();
            
            try {
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                // Hide processing modal
                processingModal.hide();
                
                if (response.ok && result.success) {
                    // Show success details
                    const profile = result.data;
                    document.getElementById('successDetails').innerHTML = `
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <div class="alert alert-success">
                                    <div class="row">
                                        <div class="col-auto">
                                            ${profile.profile_image_url ? 
                                                `<img src="${profile.profile_image_url}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">` :
                                                '<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="bi bi-person text-white"></i></div>'
                                            }
                                        </div>
                                        <div class="col">
                                            <strong>${profile.name || 'Profile'}</strong><br>
                                            ${profile.position ? `<small class="text-muted">${profile.position}</small><br>` : ''}
                                            <a href="${profile.url}" target="_blank" class="small">View LinkedIn Profile <i class="bi bi-box-arrow-up-right"></i></a>
                                        </div>
                                    </div>
                                    ${profile.companies_processed && profile.companies_processed.length > 0 ? 
                                        `<hr class="my-2"><small><strong>Companies processed:</strong> ${profile.companies_processed.length}</small>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Show success modal
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    
                } else {
                    showNotification(result.message || 'Failed to process LinkedIn profile', 'danger');
                }
                
            } catch (error) {
                // Hide processing modal
                processingModal.hide();
                
                console.error('Error processing profile:', error);
                showNotification('An error occurred while processing the LinkedIn profile', 'danger');
            }
        });
        
        // Add another profile function
        function addAnother() {
            // Close success modal
            const successModal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
            successModal.hide();
            
            // Reset form
            document.getElementById('ingestionForm').reset();
            
            // Focus on URL input
            document.getElementById('linkedinUrl').focus();
        }
    </script>
</body>
</html>
