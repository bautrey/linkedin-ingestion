<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - LinkedIn Ingestion Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="sidebar-wrapper px-0">
                <%- include('../partials/sidebar') %>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <%- include('../partials/header', { pageTitle: title }) %>
                
                <div class="container-fluid py-4">
                    <!-- Page Header with Primary Action -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold mb-1">LinkedIn Ingestion</h2>
                            <p class="text-muted mb-0">Manage profile ingestion and monitoring</p>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addProfileModal">
                                <i class="bi bi-plus-circle me-2"></i>Add LinkedIn Profile
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stat-icon bg-primary text-white me-3">
                                            <i class="bi bi-cloud-arrow-up"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">Profiles Today</h6>
                                            <h3 class="mb-0 text-muted">—</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stat-icon bg-success text-white me-3">
                                            <i class="bi bi-check-circle"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">Success Rate</h6>
                                            <h3 class="mb-0 text-muted">—</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stat-icon bg-warning text-white me-3">
                                            <i class="bi bi-building"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">Companies Found</h6>
                                            <h3 class="mb-0 text-muted">—</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="stat-icon bg-info text-white me-3">
                                            <i class="bi bi-clock-history"></i>
                                        </div>
                                        <div>
                                            <h6 class="text-muted mb-0">Avg. Time</h6>
                                            <h3 class="mb-0 text-muted">—</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ingestion Jobs Table - Coming Soon -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom d-flex align-items-center justify-content-between">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-list-ul me-2"></i>Ingestion Jobs
                            </h5>
                            <span class="badge bg-warning text-dark">Coming Soon</span>
                        </div>
                        <div class="card-body">
                            <!-- Coming Soon Preview Table -->
                            <div class="table-responsive opacity-50">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Profile URL</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Companies Found</th>
                                            <th>Started</th>
                                            <th>Duration</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>job_abc123</code></td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <i class="bi bi-linkedin text-linkedin"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">linkedin.com/in/john-doe</div>
                                                        <small class="text-muted">John Doe</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-arrow-clockwise spin me-1"></i>Processing
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="width: 120px; height: 8px;">
                                                    <div class="progress-bar bg-primary" style="width: 65%"></div>
                                                </div>
                                                <small class="text-muted">Profile + 5/8 companies</small>
                                            </td>
                                            <td>
                                                <span class="text-muted">5</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">2 min ago</small>
                                            </td>
                                            <td>
                                                <small class="text-muted">00:02:34</small>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" disabled>
                                                        Actions
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><code>job_def456</code></td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <i class="bi bi-linkedin text-linkedin"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">linkedin.com/in/jane-smith</div>
                                                        <small class="text-muted">Jane Smith</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle me-1"></i>Completed
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="width: 120px; height: 8px;">
                                                    <div class="progress-bar bg-success" style="width: 100%"></div>
                                                </div>
                                                <small class="text-success">Profile + 12 companies</small>
                                            </td>
                                            <td>
                                                <span class="text-success fw-medium">12</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">5 min ago</small>
                                            </td>
                                            <td>
                                                <small class="text-muted">00:04:22</small>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" disabled>
                                                        Actions
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><code>job_ghi789</code></td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <i class="bi bi-linkedin text-linkedin"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-medium">linkedin.com/in/mike-wilson</div>
                                                        <small class="text-muted">Mike Wilson</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-exclamation-triangle me-1"></i>Failed
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="width: 120px; height: 8px;">
                                                    <div class="progress-bar bg-danger" style="width: 25%"></div>
                                                </div>
                                                <small class="text-danger">Profile fetch failed</small>
                                            </td>
                                            <td>
                                                <span class="text-muted">—</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">8 min ago</small>
                                            </td>
                                            <td>
                                                <small class="text-muted">00:00:45</small>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" disabled>
                                                        Actions
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Coming Soon Overlay -->
                            <div class="text-center mt-4">
                                <div class="badge bg-warning text-dark fs-6 px-3 py-2">
                                    <i class="bi bi-tools me-2"></i>Real-time job tracking coming soon
                                </div>
                                <p class="text-muted mt-2 mb-0">
                                    For now, use the button above to add profiles directly. Job history and monitoring will be available in a future update.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal fade" id="addProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>Add LinkedIn Profile
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addProfileForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="linkedinUrl" class="form-label">LinkedIn Profile URL</label>
                            <input type="url" class="form-control" id="linkedinUrl" name="linkedin_url" 
                                   placeholder="https://www.linkedin.com/in/username/"
                                   pattern="https://.*linkedin\.com/in/.+"
                                   required>
                            <div class="form-text">
                                Enter the full LinkedIn profile URL (e.g., https://www.linkedin.com/in/username/)
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="suggestedRole" class="form-label">Suggested Role</label>
                            <select class="form-select" id="suggestedRole" name="suggested_role" required>
                                <option value="">Select a role...</option>
                                <option value="CTO">CTO - Chief Technology Officer</option>
                                <option value="CIO">CIO - Chief Information Officer</option>
                                <option value="CISO">CISO - Chief Information Security Officer</option>
                            </select>
                            <div class="form-text">
                                This helps with role-specific scoring and analysis
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCompanies" name="include_companies" checked>
                            <label class="form-check-label" for="includeCompanies">
                                Include company profiles from experience
                            </label>
                            <div class="form-text">
                                Automatically fetch and store company information for all positions listed in the profile
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-cloud-arrow-up me-1"></i>Add Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle me-2"></i>Profile Added Successfully
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Profile Ingestion Started</h4>
                        <p class="text-muted mb-4">The LinkedIn profile has been successfully added and is being processed.</p>
                        <div id="successDetails"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="/profiles" class="btn btn-primary">
                        <i class="bi bi-people me-1"></i>View Profiles
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js?v=<%= Date.now() %>"></script>
    <script>
        // Add Profile Form Handler
        document.getElementById('addProfileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                linkedin_url: formData.get('linkedin_url'),
                suggested_role: formData.get('suggested_role'),
                include_companies: formData.has('include_companies')
            };
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            try {
                // Show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i>Processing...';
                
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Close add modal
                    const addModal = bootstrap.Modal.getInstance(document.getElementById('addProfileModal'));
                    addModal.hide();
                    
                    // Show success details
                    document.getElementById('successDetails').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Profile:</strong> ${result.data.name || 'Profile'}<br>
                            <strong>URL:</strong> <a href="${result.data.url}" target="_blank">${result.data.url}</a><br>
                            ${result.data.companies_processed ? `<strong>Companies:</strong> ${result.data.companies_processed.length} found and processed` : ''}
                        </div>
                    `;
                    
                    // Show success modal
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                    
                    // Reset form
                    this.reset();
                    
                } else {
                    // Handle error
                    showNotification(result.message || 'Failed to add profile', 'danger');
                }
                
            } catch (error) {
                console.error('Error adding profile:', error);
                showNotification('An error occurred while adding the profile', 'danger');
            } finally {
                // Restore button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });
        
        // Simple spinning animation for processing indicators
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
